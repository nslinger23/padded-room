USERNAME="$1"
CONFIG_DIR="/config/easy-rsa2"

if [[ $UID != 0 ]]; then
    echo "Please run this script with sudo:"
    echo "sudo $0 $*"
    exit 1
fi

if [ -z $1 ]
  then
    echo "No user name supplied.  Please enter a username."
    exit 1
fi

echo "Setting up Tunnelblick VPN for $1"

cd $CONFIG_DIR

source ./vars

echo "Creating the key for $USERNAME"
./build-key $USERNAME

if [ -d $CONFIG_DIR/keys/$USERNAME.tblk ]; then
  echo "$USERNAME.tblk directory exists, updating."
else
  echo "The $USERNAME directory does not exist.  Creating"
  mkdir $CONFIG_DIR/keys/$USERNAME.tblk
fi

echo "Creating config file"
cat << EOF > $CONFIG_DIR/keys/$USERNAME.tblk/client.conf |
client
dev tun
proto udp
remote 162.247.128.73 443
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
cert $USERNAME.crt
key $USERNAME.key
cipher AES-256-CBC
comp-lzo
verb 5
EOF

echo "Creating $USERNAME file for the user"
cp -R $CONFIG_DIR/keys/ca.crt $CONFIG_DIR/keys/$USERNAME.crt $CONFIG_DIR/keys/$USERNAME.key $CONFIG_DIR/keys/$USERNAME.tblk

echo "Zipping it up for you."
tar cvfz $CONFIG_DIR/keys/$USERNAME.tblk.tar.gz -C $CONFIG_DIR/keys/ $USERNAME.tblk/

echo "Location of your Tunnelblick config $CONFIG_DIR/keys/$USERNAME.tblk.tar.gz"
